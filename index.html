<!DOCTYPE html>
<html>
<head>
	<title>Login</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>
<body>

<style>

@import url('https://fonts.googleapis.com/css?family=Roboto');

body {

width:100%;
height:100%;
margin:0 auto;
padding:0;
font-family:Roboto;

}

#boxUp {

width:100%;
height:100px;
background: red;
display:flex;
justify-content: flex-end;

}

form {

margin:auto;

}	

input {

display:block;
margin: auto;
margin-top:8px;
padding:10px;
text-decoration:none;
outline:none;

}

label {

margin:auto;
display:block;
text-align:center;
font-family: sans-serif;
font-weight:bold;
padding-top:5px;

}

input[type="button"]{

width:90px;
height:60px;

}

input[type="text"],input[type="password"]{

width:300px;

}

input[type="text"]:focus,input[type="password"]:focus {

border:1px green solid;

}

#boxMain {

width:100%;
height:250px;
background:grey;
display:flex;
justify-content: flex-center;

}

#boxJokes {

overflow-y:auto; 
overflow-x:hidden; 
height:400px;
max-height:500px;
width:70%;
background:red;

}

#logoutBox {

width:100px;
height:100px;
background:green;
display:none; 

}

.joke {

width:100%;
height:130px;
/*background:green;*/
margin-top:20px;
font-size:25px;
text-align:center;
/*line-height: 70px;*/
color:white;

}

#formSendJoke {

display:none;

}

#jokeSend,#jokeGet,#passReset {

width:324px;

}

#error401,#error403 {

color:red;
font-size:20px;
margin-top:5px;
text-align:center;
display:none;

}

#passReset {

text-align:center;
cursor: pointer;
margin-top:8px;

}

#formResetPass {

display:none;

}

</style>

<div id="boxUp">
	<div id='logoutBox'><input type='button' value='logout' class='logoutBtn' onclick='logout()'></div>
</div>

<div id="boxMain">

<form id="formLogin">
	<label>Username</label>
	<input type="text" name="username" id="field1">
	<label>Password</label>
	<input type="password" name="pass" id="field2">
	<div id="error401">You entered wrong login name or password</div>
	<div id="error403">You have something wrong in request</div>
	<input type="button" name="submit" value="Login" onclick="getData()">
</form>
<form id="formResetPass">
  <label>Old password</label>
  <input type="password" name="oldpass">
  <label>New password</label>
  <input type="password" name="newpass">
  <input type="button" id="changepass" onclick="changePass()" value="Change Password">
</form>

<form id="formSendJoke">
	<label class="hdnLabel">Send joke!</label>
	<input class="hdnField" type="text" name="joke">
  <input type="button" id="passReset" value="Reset password" onclick="toPass()">
</form>

</div>

<div id="boxJokes">


</div>

<script type="text/javascript">

function getData(){

/*variables values from form*/
let nickname=document.getElementsByName("username")[0].value;
let pass=document.getElementsByName("pass")[0].value;

/*
let clear1=document.getElementById("field1");
let clear2=document.getElementById("field2");
clear1.value = '';
clear2.value = '';*/

xhr = new XMLHttpRequest();
let url = "http://itsovy.sk:1201/login";
xhr.open("POST", url, true);
xhr.setRequestHeader("Content-type", "application/json");
xhr.onreadystatechange = function () { 
    
    console.log(xhr.status);

    if (xhr.readyState == 4 && xhr.status == 200) {
        let json = JSON.parse(xhr.responseText);

        /*session*/
        sessionStorage.setItem('loginName', json.login);
        sessionStorage.setItem('loginToken', json.token);
       	/*variable for session*/
       	let token=sessionStorage.getItem('loginToken');
        let enteredName=sessionStorage.getItem('loginName');
       	console.log(token);
        console.log(enteredName);

        document.getElementById("formLogin").style.display="none";
        document.getElementById("logoutBox").style.display="block";
        document.getElementById("formSendJoke").style.display="block";
        document.getElementById("error401").style.display="none";
        document.getElementById("error403").style.display="none";

        /*clean fields in form*/
        document.getElementById("field1").value="";
        document.getElementById("field2").value="";
 
        $( "#formSendJoke" ).append( "<input type='button' id='jokeSend' value='Send joke' onclick='sendJoke()'>" );
        $( "#formSendJoke" ).append( "<input type='button' id='jokeGet' value='Get joke' onclick='getJoke()'>" );

    }

    if(xhr.status == 401){
    	document.getElementById("error401").style.display="block";
    }


    if(xhr.status == 403){
    	document.getElementById("error403").style.display="block";
    }

}

let data = JSON.stringify({login:nickname,password:pass});
xhr.send(data);

}

function getJoke(){

let token=sessionStorage.getItem('loginToken');
let enteredName=sessionStorage.getItem('loginName');
console.log(xhr.status);
console.log(token);
console.log(enteredName);

xhr = new XMLHttpRequest();
let url = "http://itsovy.sk:1201/joke";
xhr.open("POST", url, true);
xhr.setRequestHeader("Content-type", "application/json");
xhr.onreadystatechange = function () { 
    if (xhr.readyState == 4 && xhr.status == 200) {
      let json = JSON.parse(xhr.responseText);
        
      let joke = json.joke
      $( "#boxJokes" ).append( "<div class='joke'>"+joke+"</div>" );

    }
}
let data = JSON.stringify({login:enteredName,token:token});
xhr.send(data);

}

function sendJoke(){

document.getElementsByClassName("hdnField")[0].value="";
let token=sessionStorage.getItem('loginToken');
let enteredName=sessionStorage.getItem('loginName');
let jokeEntered= document.getElementsByName("joke")[0].value;

console.log(xhr.status);
console.log(token);
console.log(enteredName);
console.log(jokeEntered);

xhr = new XMLHttpRequest();
let url = "http://itsovy.sk:1201/addjoke";
xhr.open("POST", url, true);
xhr.setRequestHeader("Content-type", "application/json");
xhr.onreadystatechange = function () { 
    if (xhr.readyState == 4 && xhr.status == 200) {
      let json = JSON.parse(xhr.responseText);

    }
}
let data = JSON.stringify({login:enteredName,token:token,joke:jokeEntered});
xhr.send(data);

}

function logout(){

  let token=sessionStorage.getItem('loginToken');
  let enteredName=sessionStorage.getItem('loginName');
  console.log(xhr.status);
  console.log(token);
  console.log(enteredName);

  xhr = new XMLHttpRequest();
  let url = "http://itsovy.sk:1201/logout";
  xhr.open("POST", url, true);
  xhr.setRequestHeader("Content-type", "application/json");
  xhr.onreadystatechange = function () { 
      if (xhr.readyState == 4 && xhr.status == 200) {
       
        document.getElementById("formLogin").style.display="block";
        document.getElementById("logoutBox").style.display="none";
        document.getElementById("formSendJoke").style.display="none";
        document.getElementById("formResetPass").style.display="none";
       
        $( "#jokeSend" ).remove();
        $( "#jokeGet" ).remove();

      }
  }
  let data = JSON.stringify({login:enteredName,token:token});
  xhr.send(data);

}

function toPass(){


document.getElementById("formSendJoke").style.display="none";
document.getElementById("formResetPass").style.display="block";


}

function changePass(){

let token=sessionStorage.getItem('loginToken');
let enteredName=sessionStorage.getItem('loginName');

let oldpass = document.getElementsByName("oldpass")[0].value;
let newpass = document.getElementsByName("newpass")[0].value;

console.log(oldpass+newpass);
console.log(xhr.status);
console.log(token);
console.log(enteredName);

xhr = new XMLHttpRequest();
let url = "http://itsovy.sk:1201/changepassword";
xhr.open("POST", url, true);
xhr.setRequestHeader("Content-type", "application/json");
xhr.onreadystatechange = function () { 
    if (xhr.readyState == 4 && xhr.status == 200) {
      /*let json = JSON.parse(xhr.responseText);*/

        document.getElementById("formResetPass").style.display="none";
        document.getElementById("formSendJoke").style.display="block";

    }
}
let data = JSON.stringify({login:enteredName,token:token,oldpassword:oldpass,newpassword:newpass});
xhr.send(data);

}

</script>

</body>
</html>